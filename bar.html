<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>bar</title>
	<meta name="author" content="pjv">
	<!-- Date: 2010-06-15 -->
	<link rel="stylesheet" href="./sexybuttons.css" type="text/css">	
	<link rel="stylesheet" href="./style.css" type="text/css">
	
	<script type="text/javascript">
        
        // TODO custom delay time
        // TODO prefs to always auto-reload specified URLs
        
        hide(); // start off hidden
        safari.self.browserWindow.addEventListener("command", handleCommand, false);
        safari.self.browserWindow.addEventListener("validate", handleValidate, false); 
        safari.extension.settings.addEventListener("change", handleChange, false); 
        
        var sexyButtons = document.getElementsByTagName("button");
        var hangAroundTabs = [];
        var _activeTab = safari.self.browserWindow.activeTab;
        var autoHide = safari.extension.settings.hide_bar;
        var timerDisplayID;
        
        function pruneHangArounds () {
            var tmp = [];
            
            for (var i = 0; i < hangAroundTabs.length; i++) {
                if (hangAroundTabs[i].timerID && hangAroundTabs[i].browserWindow)
                    tmp.push(hangAroundTabs[i]);
            }
            hangAroundTabs = tmp;
            delete tmp;
        } // pruneHangArounds      
                        
        function handleChange (chgEvent){
            switch(chgEvent.key){
                case "hide_bar":
                    autoHide = chgEvent.newValue;
                    break;
                default:
            }
        } // handleChange
        
        function handleCommand (commandMsg) {
            switch(commandMsg.command){
                case "toggle_from_button":
                    _activeTab = safari.self.browserWindow.activeTab;
                    if (safari.self.visible){
                        hide();
                        return;
                    }
                    else {
                        updateBar(_activeTab);
                        safari.self.show();
                    }
                    break;
            } // switch
        } //handleCommand
        
        function handleValidate (validateMsg) {
            switch(validateMsg.command){
                case "toggle_from_button":                
                    _activeTab = safari.self.browserWindow.activeTab;
                    var currentURL = _activeTab.url;
                    
                    // set active tab as being read
                    _activeTab.reloaderUnread = false;
                    
                    // prune out list of tabs in case we're here because of a closed tab
                    pruneHangArounds();
                    
                    // mark tabs as read / unread
                    markTabs();
                    
                    // test for user navigating to a new URL in a reloading tab and disable reloading if so
                    if (_activeTab.timerID && (_activeTab.url !== _activeTab.originalURL))
                        disable(_activeTab);
                    
                    // disable tab reloader and return if no URL in tab
                    if (! currentURL) {
                        // disable the menu item and the toolbar button
                        validateMsg.target.disabled = true;
                        hide();
                        return;
                    } // if
                    else
                        validateMsg.target.disabled = false;
                                        
                    // update bar if necessary
                    if (safari.self.visible)
                        updateBar(_activeTab);
                    break;   
            } // switch
        } // handleValidate
        
        function displayLastReloadTime(tab){
            var lastHours = tab.reloadTime.getHours();
            var lastMinutes = tab.reloadTime.getMinutes();
            var lastSeconds = tab.reloadTime.getSeconds();
            var lastAorP;
            
            if (lastHours >= 12)
                lastAorP = "pm";
            else
                lastAorP = "am";
                
            if (lastHours >= 13)
                lastHours -= 12;
            
            if (lastMinutes < 10)
                lastMinutes = "0" + lastMinutes;
            
            if (lastSeconds < 10)
                lastSeconds = "0" + lastSeconds;
            
            var lastUpdate = lastHours + ":" + lastMinutes + ":" + lastSeconds + " " + lastAorP + " | ";
            
            document.getElementById('last_update').innerHTML = lastUpdate;
        }
        
        function displayCountdown(tab){
            var reloadTime = tab.reloadTime;
            if (! reloadTime)
                reloadTime = new Date();

            var nextReload = new Date();    
                        
            nextReload.setTime(reloadTime.getTime() + tab.delay);  
            
            var now = new Date();      
            
            timeLeft = nextReload.getTime() - now.getTime();
            
            delete nextReload;
            delete reloadTime;
            delete now;
            
            days=0;hours=0;mins=0;secs=0;

    		timeLeft = Math.floor(timeLeft/1000);//kill the "milliseconds" so just secs

    		days=Math.floor(timeLeft/86400);//days
    		
    		timeLeft=timeLeft%86400;
    		hours=Math.floor(timeLeft/3600);//hours
    		
    		timeLeft=timeLeft%3600;
    		mins=Math.floor(timeLeft/60);//minutes
    		
    		timeLeft=timeLeft%60;
    		secs=Math.floor(timeLeft);//seconds
                            
            if (hours >= 13)
                hours -= 12;
                
            if (hours < 10)
                hours = "0" + hours;
            
            if (mins < 10)
                mins = "0" + mins;
            
            if (secs < 10)
                secs = "0" + secs;
            
            var nextUpdate = hours + ":" + mins + ":" + secs;
            
            document.getElementById('next_update').innerHTML = nextUpdate;
            
            timerDisplayID = setTimeout(function() {return displayCountdown(tab);},1000);
        }
        
        function updateBar (tab) {
            var db = document.getElementById('disable_button');
            var hb = document.getElementById('hide_button');
            var am = document.getElementById('rt_active');
            var im = document.getElementById('rt_inactive');
            var cd = document.getElementById(tab.buttonID);
            var bcustom = document.getElementById('bcustom');
            var bsimple = document.getElementById('bsimple');
            
            resetButtonColors();

            if (tab.reloadEnabled) {
                
                // show disable button
                db.style.display = 'inline-block';
                
                // hide simple and custom buttons
                bcustom.style.display = 'none';
                bsimple.style.display = 'none';

                // show active marker
                am.style.display = 'inline-block';
                im.style.display = 'none';

                // custom delay panel
                if (! tab.customDelay){
                    showDelay('simple_delay');
                    
                    // current delay green button
                    if (cd)
                        cd.className = "sexybutton sexysimple sexysmall sexygreen";
                }   
                else {
                    showDelay('custom_delay');
                    
                    // values
                    document.getElementById('cust_hours').value     = tab.customDelay.hours;
                    document.getElementById('cust_minutes').value   = tab.customDelay.minutes;
                    document.getElementById('cust_seconds').value   = tab.customDelay.seconds;
                    
                    resetCustomColors();
                }
                
                // last update and countdown display
                document.getElementById('display_begin').innerHTML = "[ ";
                document.getElementById('display_end').innerHTML = " ]";
                clearTimeout(timerDisplayID);
                displayCountdown(tab);
                
                if (tab.reloadTime){
                    displayLastReloadTime(tab);
                }    
            } // if
            else {
                
                // hide disable button
                db.style.display = 'none';
                
                // show custom and simple buttons
                bcustom.style.display = 'inline';
                bsimple.style.display = 'inline';

                // show inactive marker
                am.style.display = 'none';
                im.style.display = 'inline-block';
                
                // custom delay panel
                document.getElementById('cust_hours').value     = 0;
                document.getElementById('cust_minutes').value   = 0;
                document.getElementById('cust_seconds').value   = 0;
                
                resetCustomColors();
                
                // last update and countdown display
                clearTimeout(timerDisplayID);
                document.getElementById('last_update').innerHTML = "";
                document.getElementById('next_update').innerHTML = "";
                document.getElementById('display_begin').innerHTML = "";
                document.getElementById('display_end').innerHTML = "";
            } // else
        } // updateBar
        
        function reloadTab (tab) {
            var currentURL = tab.url;
                        
            if (currentURL && tab.reloadEnabled) {
                tab.url = currentURL;
                tab.reloadTime = new Date();
                tab.reloaderUnread = true;
                //updateBar();
            } // if                       
        } // reloadTab
        
        function markTabs(){
            for (var i = 0; i < hangAroundTabs.length; i++) {
                if (hangAroundTabs[i].reloaderUnread)
                    hangAroundTabs[i].page.dispatchMessage("markTabUnread");
                else
                    hangAroundTabs[i].page.dispatchMessage("markTabRead");
            }
        }
        
        function setDelay(delay,buttonID,custom) {
            var tab = safari.self.browserWindow.activeTab;                       

            if (custom){
                tab.customDelay         = {};
                tab.customDelay.hours   = document.getElementById('cust_hours').value;
                tab.customDelay.minutes = document.getElementById('cust_minutes').value;
                tab.customDelay.seconds = document.getElementById('cust_seconds').value;

                delay   = (tab.customDelay.seconds * 1000)
                        + (tab.customDelay.minutes * 1000 * 60)
                        + (tab.customDelay.hours * 1000 * 60 * 60);
                        
                // no zero delays
                if (delay == 0){
                    alert("You must set a delay.");
                    return;
                }
            }
            else {
                // clear custom stuff if it exists
                if (tab.customDelay)
                    delete tab.customDelay;
                    
                delay = delay * 1000 * 60; // convert to msec {yeah, yeah, aka 60,000}
            }
            
            // clear old timer if it exists
            if (tab.timerID) {
                clearInterval(tab.timerID);
            }
                  
            resetButtonColors();            
            tab.buttonID = buttonID;
            tab.delay = delay;
            tab.reloadEnabled = true;
            tab.originalURL = tab.url;
            tab.reloadTime = new Date();
            tab.timerID = setInterval(function() { return reloadTab(tab); },delay);
            
            // add to the list of tabs we are paying attention to
            // solves this bug: https://devforums.apple.com/message/233887
            hangAroundTabs.push(tab);
                      
            // hide the bar
            if (autoHide)
                hide();
            else
                updateBar(tab);
        } // setDelay
        
        function disable (tab) {
            if (! tab) // this is for the button in the bar
                tab = safari.self.browserWindow.activeTab;
            
            tab.page.dispatchMessage("markTabRead");
            tab.reloadEnabled = false;
            tab.delay = null;
            if (tab.customDelay){
                document.getElementById('cust_hours').value     = 0;
                document.getElementById('cust_minutes').value   = 0;
                document.getElementById('cust_seconds').value   = 0;
                resetCustomColors();
                delete tab.customDelay;
            }
            tab.buttonID = null;
            tab.originalURL = null;
            tab.reloaderUnread = null;
            clearInterval(tab.timerID);
            clearTimeout(timerDisplayID);
            tab.timerID = null;
            pruneHangArounds();

            // hide the bar
            if (autoHide)
                hide();
            else
                updateBar(tab);
        } // disable
        
        function hide() {
            // hide the bar
            safari.self.hide();
        } // hide
        
        function resetButtonColors () {
            var greenButtons = document.getElementsByClassName('sexygreen');
            
            if (greenButtons) {
                for (i=0;i<greenButtons.length;i++)
                    greenButtons[i].className = "sexybutton sexysimple sexysmall";
            }
        }
        
        function resetCustomColors(){
            if (document.getElementById('cust_hours').value != 0)
                document.getElementById('cust_hours').className = "green";
            else
                document.getElementById('cust_hours').className = "black";
            
            if (document.getElementById('cust_minutes').value != 0)
                document.getElementById('cust_minutes').className = "green";
            else
                document.getElementById('cust_minutes').className = "black";
            
            if (document.getElementById('cust_seconds').value != 0)
                document.getElementById('cust_seconds').className = "green";
            else
                document.getElementById('cust_seconds').className = "black";
        }
        
        function showDelay(div){
            var showDiv = document.getElementById(div);
            var hideDiv;
            
            if (div === "simple_delay")
                hideDiv = document.getElementById("custom_delay");
            else
                hideDiv = document.getElementById("simple_delay");
                
            hideDiv.style.display  = "none";
            showDiv.style.display  = "inline-block"; 
            showDiv.style.position = "relative"; 
            showDiv.style.bottom   = "4px"; 
        }


    </script>
</head>
<body> 
    <div id="content" >
        <div style="display: inline-block; position: relative; bottom: 1px;">
        <span id="rt_active" style="color: #59a901;" class="marker">&diams;</span>
        <span id="rt_inactive" style="color: red;" class="marker">&diams;</span>
        Reload Tab Every: </div>
        <div id="simple_delay" style="display: inline-block; position: relative; bottom: 4px">
            <button id="b1" class="sexybutton sexysimple sexysmall" onclick="setDelay(.5,'b1',false)">30 sec</button>
            <button id="b2" class="sexybutton sexysimple sexysmall" onclick="setDelay(1,'b2',false)">1 min</button>
            <button id="b3" class="sexybutton sexysimple sexysmall" onclick="setDelay(2,'b3',false)">2 min</button>
            <button id="b4" class="sexybutton sexysimple sexysmall" onclick="setDelay(5,'b4',false)">5 min</button>
            <button id="b5" class="sexybutton sexysimple sexysmall" onclick="setDelay(15,'b5',false)">15 min</button>
            <button id="b6" class="sexybutton sexysimple sexysmall" onclick="setDelay(30,'b6',false)">30 min</button>
            <button id="b7" class="sexybutton sexysimple sexysmall" onclick="setDelay(60,'b7',false)">60 min</button>
            &nbsp;&nbsp;
            <button id="bcustom" class="sexybutton sexysimple sexysmall sexyorange" onclick="showDelay('custom_delay')">Custom</button>
        </div>
        <div id="custom_delay" style="display: none">
            <select name="cust_hours" id="cust_hours">
                <option value="0">-</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
            </select><span class="down">hrs</span>
            <select name="cust_minutes" id="cust_minutes">
                <option value="0">-</option><option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> <option value="16">16</option> <option value="17">17</option> <option value="18">18</option> <option value="19">19</option> <option value="20">20</option> <option value="21">21</option> <option value="22">22</option> <option value="23">23</option> <option value="24">24</option> <option value="25">25</option> <option value="26">26</option> <option value="27">27</option> <option value="28">28</option> <option value="29">29</option> <option value="30">30</option> <option value="31">31</option> <option value="32">32</option> <option value="33">33</option> <option value="34">34</option> <option value="35">35</option> <option value="36">36</option> <option value="37">37</option> <option value="38">38</option> <option value="39">39</option> <option value="40">40</option> <option value="41">41</option> <option value="42">42</option> <option value="43">43</option> <option value="44">44</option> <option value="45">45</option> <option value="46">46</option> <option value="47">47</option> <option value="48">48</option> <option value="49">49</option> <option value="50">50</option> <option value="51">51</option> <option value="52">52</option> <option value="53">53</option> <option value="54">54</option> <option value="55">55</option> <option value="56">56</option> <option value="57">57</option> <option value="58">58</option> <option value="59">59</option> <option value="60">60</option>
            </select><span class="down">min</span>
            <select name="cust_seconds" id="cust_seconds">
                <option value="0">-</option><option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> <option value="16">16</option> <option value="17">17</option> <option value="18">18</option> <option value="19">19</option> <option value="20">20</option> <option value="21">21</option> <option value="22">22</option> <option value="23">23</option> <option value="24">24</option> <option value="25">25</option> <option value="26">26</option> <option value="27">27</option> <option value="28">28</option> <option value="29">29</option> <option value="30">30</option> <option value="31">31</option> <option value="32">32</option> <option value="33">33</option> <option value="34">34</option> <option value="35">35</option> <option value="36">36</option> <option value="37">37</option> <option value="38">38</option> <option value="39">39</option> <option value="40">40</option> <option value="41">41</option> <option value="42">42</option> <option value="43">43</option> <option value="44">44</option> <option value="45">45</option> <option value="46">46</option> <option value="47">47</option> <option value="48">48</option> <option value="49">49</option> <option value="50">50</option> <option value="51">51</option> <option value="52">52</option> <option value="53">53</option> <option value="54">54</option> <option value="55">55</option> <option value="56">56</option> <option value="57">57</option> <option value="58">58</option> <option value="59">59</option> <option value="60">60</option>
            </select><span class="down">sec</span>
            <button id="bactivate" class="sexybutton sexysimple sexysmall" onclick="setDelay(null,null,true)">Set</button>
            &nbsp;&nbsp;
            <button id="bsimple" class="sexybutton sexysimple sexysmall sexyorange" onclick="showDelay('simple_delay')">Simple</button>
        </div>
        
        <div style="float: right; display: inline-block; position: relative; bottom: 3px">
            <span id="update_display" style="display: inline-block; position: relative; bottom: -2px; color: #ffff99; font: 'Lucida Grande', Arial, 'Helvetica Neue', Helvetica; font-size: 10px; font-weight: normal;">
                <span id="display_begin"></span>
                <span id="last_update"></span>
                <span id="next_update"></span>
                <span id="display_end"></span>
            </span>
            <button id="hide_button" class="sexybutton sexysimple sexysmall" onclick="hide()">Hide</button>
            <button id="disable_button" class="sexybutton sexysimple sexysmall" onclick="disable()">Disable</button>
        </div>
    </div> <!-- content -->
</body>
</html>
