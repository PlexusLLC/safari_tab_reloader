<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>bar</title>
	<meta name="author" content="pjv">
	<!-- Date: 2010-06-15 -->
	<script type="text/javascript">
        
        hide(); // start off hidden
        safari.self.browserWindow.addEventListener("command", handleCommand, false);
        safari.self.browserWindow.addEventListener("validate", handleValidate, false); 
        
        var hangAroundTabs = [];
        
        // function pruneHangArounds () {
        //     for (tab in hangAroundTabs) {
        //         if (tab ! in safari.self.browserWindow.tabs) // doesn't work -- no 'in' with objects
        //             hangAroundTabs.splice[tab,1];
        //     }
        // }
        
        // setInterval(pruneHangArounds,600000) // every 10 minutes
                
        function handleCommand (commandMsg) {
            switch(commandMsg.command){
                case "tab_reloader":
                    safari.self.show();
                default :
                    //
            } // switch
        } //handleCommand
        
        function handleValidate (validateMsg) {
            // show/hide disable button
            switch(validateMsg.command){
                case "tab_reloader":
                    var activeTab = safari.self.browserWindow.activeTab;
                    var db = document.getElementById('disable_button');
                    var hb = document.getElementById('hide_button');
                    var am = document.getElementById('rt_active');
                    var im = document.getElementById('rt_inactive');
 
                    if (activeTab.reloadEnable) {
                        document.body.style.padding = "2px";
                        document.body.style.border = "green 2px solid";
                        
                        // show disable button
                        db.style.display = 'inline';

                        // show active marker
                        am.style.display = 'inline';
                        im.style.display = 'none';
                        
                    }
                    else {
                        document.body.style.padding = "2px";
                        document.body.style.border = "red 2px solid";
                        
                        // hide disable button
                        db.style.display = 'none';

                        // show inactive marker
                        am.style.display = 'none';
                        im.style.display = 'inline';
                    } // else                       
            } // switch
        } // handleValidate
        
        function reloadTab (activeTab) {
            var currentURL = activeTab.url;
            
            // alert (currentURL);
            
            if (currentURL && activeTab.reloadEnable) {
                activeTab.url = currentURL;
                
                // alas, this doesn't really work because loading the URL is async
                // setTimeout(function() { return activeTab.page.dispatchMessage('setTitleUnread'); },1000);
            } // if                       
        } // reloadTab
        
        function setDelay(delay) {
            var activeTab = safari.self.browserWindow.activeTab;
            
            delay = delay * 1000 * 60; // convert to msec
            
            // clear old timer if it exists
            if (activeTab.timerID)
                clearInterval(activeTab.timerID);
            
            activeTab.delay = delay;
            activeTab.reloadEnable = true;
            activeTab.timerID = setInterval(function() { return reloadTab(activeTab); },delay);
            
            // add to the list of tabs we are paying attention to
            // solves this bug: https://devforums.apple.com/message/233887
            // if (! activeTab in hangAroundTabs)  // doesn't work -- no 'in' with objects
            hangAroundTabs.push(activeTab);
                      
            // hide the bar
            safari.self.hide();
        } // setDelay
        
        function disable () {
            var activeTab = safari.self.browserWindow.activeTab;
            activeTab.reloadEnable = false;
            clearInterval(activeTab.timerID);
            // activeTab.page.dispatchMessage("setTitleRead");
            
            // hide the bar
            safari.self.hide();
        } // disable
        
        function hide() {
            // hide the bar
            safari.self.hide();
        } // cancel

    </script>
</head>
<body> 
    <div id="content" style="padding: 0px 2px 2px 2px;">
        Reload Tab Every: 
        <span id="delay_buttons">
            <input type=button value="30 sec" onclick="setDelay(.5)">
            <input type=button value="1 min" onclick="setDelay(1)">
            <input type=button value="2 min" onclick="setDelay(2)">
            <input type=button value="5 min" onclick="setDelay(5)">
            <input type=button value="15 min" onclick="setDelay(15)">
            <input type=button value="30 min" onclick="setDelay(30)">
            <input type=button value="60 min" onclick="setDelay(60)">
        </span>
        <!-- TODO: add field and popup (secs, mins, hrs) for custom delay -->
        <div align="right" style="float: right">
            <input id="hide_button" type=button value="Hide" onclick="hide()">
            <input id="disable_button" type=button value="Disable" onclick="disable()">
            <span id="rt_active" style="color: white; background: green; padding: 2px;">Active</span>
            <span id="rt_inactive" style="color: white; background: red; padding: 2px;">Inactive</span>
        </div>
    </div>
</body>
</html>
