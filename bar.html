<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>bar</title>
	<meta name="author" content="pjv">
	<!-- Date: 2010-06-15 -->
	<link rel="stylesheet" href="./sexybuttons.css" type="text/css">
	<script type="text/javascript">
        
        // TODO custom delay time
        // TODO prefs to always auto-reload specified URLs
        // TODO show last updated time (and countdown to next update) in bar
        
        hide(); // start off hidden
        safari.self.browserWindow.addEventListener("command", handleCommand, false);
        safari.self.browserWindow.addEventListener("validate", handleValidate, false); 
        safari.self.browserWindow.addEventListener("message", handleMessage, false); 
        
        var sexyButtons = document.getElementsByTagName("button");
        var hangAroundTabs = [];
        var _activeTab = safari.self.browserWindow.activeTab;
        
        function pruneHangArounds () {
            var tmp = [];
            
            for (var i = 0; i < hangAroundTabs.length; i++) {
                if (hangAroundTabs[i].timerID && hangAroundTabs[i].browserWindow)
                    tmp.push(hangAroundTabs[i]);
            }
            hangAroundTabs = tmp;
            tmp = null;
        } // pruneHangArounds      
                        
        function handleMessage (msgEvent) {
            switch(msgEvent.name){
                case "sendMarkerStatus":                                          
                    tab = msgEvent.target;
                    _activeTab = safari.self.browserWindow.activeTab;
                    if (_activeTab === tab)
                        tab.page.dispatchMessage("markerStatus","read");
                    if ((_activeTab !== tab) && tab.reloadEnabled)
                        tab.page.dispatchMessage("markerStatus","unread");
                    break;
                case "updateBar":
                    updateBar(msgEvent.target);
                    break;
            } // switch
        }
        
        function handleCommand (commandMsg) {
            switch(commandMsg.command){
                case "toggle_from_menu":
                case "toggle_from_button":
                    _activeTab = safari.self.browserWindow.activeTab;
                    if (safari.self.visible){
                        hide();
                        return;
                    }
                    else {
                        updateBar(_activeTab);
                        safari.self.show();
                    }
                    break;
            } // switch
        } //handleCommand
        
        function handleValidate (validateMsg) {
            switch(validateMsg.command){
                case "toggle_from_menu":
                case "toggle_from_button":                
                    var tab = safari.self.browserWindow.activeTab;
                    var currentURL = tab.url;
                    
                    // prune out list of tabs in case we're here because of a closed tab
                    pruneHangArounds();
                    
                    // test for user navigating to a new URL in a reloading tab and disable reloading if so
                    if (tab.timerID && (tab.url !== tab.originalURL))
                        disable(tab);
                    
                    // disable tab reloader and return if no URL in tab
                    if (! currentURL) {
                        // disable the menu item and the toolbar button
                        validateMsg.target.disabled = true;
                        hide();
                        return;
                    } // if
                    else
                        validateMsg.target.disabled = false;
                    
                    // update bar if necessary
                    if ( !(_activeTab === safari.self.browserWindow.activeTab)) {
                        _activeTab = safari.self.browserWindow.activeTab;
                        if (safari.self.visible)
                            updateBar(_activeTab);
                        _activeTab.page.dispatchMessage("setTitleRead");
                    } // if
                    break;   
                default:
                    //
            } // switch
        } // handleValidate
        
        function updateBar (tab) {
            var db = document.getElementById('disable_button');
            var hb = document.getElementById('hide_button');
            var am = document.getElementById('rt_active');
            var im = document.getElementById('rt_inactive');
            var cd = document.getElementById(tab.buttonID);
            
            resetButtonColors();

            if (tab.reloadEnabled) {
                
                // show disable button
                db.style.display = 'inline-block';

                // show active marker
                am.style.display = 'inline-block';
                im.style.display = 'none';
                
                // current delay green button
                cd.className = "sexybutton sexysimple sexysmall sexygreen";
                
            } // if
            else {
                
                // hide disable button
                db.style.display = 'none';

                // show inactive marker
                am.style.display = 'none';
                im.style.display = 'inline-block';
            } // else
        } // updateBar
        
        function reloadTab (tab) {
            var currentURL = tab.url;
                        
            if (currentURL && tab.reloadEnabled) {
                tab.url = currentURL;
                // console.log("reloading: " + tab.title);
            } // if                       
        } // reloadTab
        
        function resetButtonColors () {
            for (i=0;i<sexyButtons.length;i++)
                sexyButtons[i].className = "sexybutton sexysimple sexysmall";
        }
        
        function setDelay(delay,buttonID) {
            var tab = safari.self.browserWindow.activeTab;            
            delay = delay * 1000 * 60; // convert to msec {yeah, yeah, aka 60,000}
            
            // clear old timer if it exists
            if (tab.timerID) {
                clearInterval(tab.timerID);
            }
                
            
            resetButtonColors();            
            tab.buttonID = buttonID;
            tab.delay = delay;
            tab.reloadEnabled = true;
            tab.originalURL = tab.url;
            tab.timerID = setInterval(function() { return reloadTab(tab); },delay);
            
            // add to the list of tabs we are paying attention to
            // solves this bug: https://devforums.apple.com/message/233887
            hangAroundTabs.push(tab);
                      
            // hide the bar
            safari.self.hide();
        } // setDelay
        
        function disable (tab) {
            tab.page.dispatchMessage("setTitleRead");
            tab.reloadEnabled = false;
            tab.delay = null;
            tab.buttonID = null;
            tab.originalURL = null;
            clearInterval(tab.timerID);
            tab.timerID = null;
            pruneHangArounds();

            // hide the bar
            safari.self.hide();
        } // disable
        
        function hide() {
            // hide the bar
            safari.self.hide();
        } // cancel

    </script>
</head>
<body > 
    <div id="content" >
        <span id="rt_active" style="color: green;">&bull;</span>
        <span id="rt_inactive" style="color: red;">&bull;</span>
        Reload Tab Every: 
        <div id="delay_buttons" style="display: inline-block; position: relative; bottom: 3px">
            <button id="b1" class="sexybutton sexysimple sexysmall" value="30 sec" onclick="setDelay(.5,'b1')">30 Sec</button>
            <button id="b2" class="sexybutton sexysimple sexysmall" value="1 min" onclick="setDelay(1,'b2')">1 min</button>
            <button id="b3" class="sexybutton sexysimple sexysmall" value="2 min" onclick="setDelay(2,'b3')">2 min</button>
            <button id="b4" class="sexybutton sexysimple sexysmall" value="5 min" onclick="setDelay(5,'b4')">5 min</button>
            <button id="b5" class="sexybutton sexysimple sexysmall" value="15 min" onclick="setDelay(15,'b5')">15 min</button>
            <button id="b6" class="sexybutton sexysimple sexysmall" value="30 min" onclick="setDelay(30,'b6')">30 min</button>
            <button id="b7" class="sexybutton sexysimple sexysmall" value="60 min" onclick="setDelay(60,'b7')">60 min</button>
        </div>
        <!-- TODO: add field and popup (secs, mins, hrs) for custom delay -->
        <div style="float: right; display: inline-block; position: relative; bottom: 3px">
            <button id="hide_button" class="sexybutton sexysimple sexysmall" onclick="hide()">Hide</button>
            <button id="disable_button" class="sexybutton sexysimple sexysmall" onclick="disable()">Disable</button>
        </div>
    </div> <!-- content -->
</body>
</html>
